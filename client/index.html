<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  
  <link rel="import" href="bower_components/polymer/polymer.html">
  
  <link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="bower_components/iron-icon/iron-icon.html">
  <link rel="import" href="bower_components/iron-icons/iron-icons.html">
  <link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
  
  <link rel="import" href="bower_components/paper-styles/paper-styles.html">
  <link rel="import" href="bower_components/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
  <link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="bower_components/paper-menu/paper-menu.html">
  <link rel="import" href="bower_components/paper-item/paper-icon-item.html">
  
  <link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
  
  <link rel="import" href="elements/app-icons/app-icons.html">
  <link rel="import" href="elements/game-space/game-space.html">
  <link rel="import" href="elements/selection-dialog/selection-dialog.html">
  <link rel="import" href="elements/main-button/main-button.html">
  <link rel="import" href="elements/my-challenges/my-challenges.html">
  <link rel="import" href="elements/challenge-entry/challenge-entry.html">
  <link rel="import" href="elements/challenge-key/challenge-key.html">
  <link rel="import" href="elements/user-level/user-level.html">
  <link rel="import" href="elements/page-heading/page-heading.html">
  <link rel="import" href="elements/main-select-field/main-select-field.html">
  
  <link rel="import" href="helpers/array-shuffle/array-shuffle.html">
  <link rel="import" href="helpers/time-formatter/time-formatter.html">
  
  <title>Typo</title>
  
  <style>
  body{
    margin: 0;
    height: 100vh;
  }
  </style>
</head>
<body>
  <dom-module id="page-element">
    <style is="custom-style">
    :root {
      --dark-primary-color: #711740;
      --light-primary-color: #952E3F; /*#bf4337;*/
      --accent-color: #FF4081;
      
      --primary-background-color: #c5cae9;
      --primary-text-color: #ffffff;
      --secondary-text-color: #727272;
      --disabled-text-color: #bdbdbd;
      --divider-color: #B6B6B6;
      --primary-border-color: #ffffff;
      
      --default-primary-color: var(--dark-primary-color);

      --drawer-menu-color: #000000;
      --drawer-border-color: 1px solid #ccc;
      --drawer-toolbar-border-color: 1px solid rgba(0, 0, 0, 0.22);
      
      --text-primary-color: #e66355;
      --paper-menu-background-color: var(--light-primary-color);
      --paper-menu-color: var(--primary-text-color);
      --menu-link-color: #111111;
      
      --easy-color: #3cc800;
      --medium-color: #3c96ff;
      --hard-color: #c80000;
      --accept-color: #ff6867;
      
      --selection-dialog-color: #cccccc;
      --selection-dialog-header-color: #ffffff;
      --selection-dialog-close-btn-color: var(--light-primary-color);
      
      --game-space-header-color: #e66355;
    }
    :host,
    main-button{
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      @apply(--paper-font-common-base);
    }
    neon-animated-pages{
      @apply(--layout-fit);
    }
    paper-toolbar{
      --paper-toolbar: {
        font-size: 19px;
        padding: 0 8px;
      };
    }
    paper-menu{
      @apply(--layout-fit);
    }
    selection-dialog{
      font-size: 2.5vh;
      line-height: normal;
    }
    selection-dialog main-button{
      width: 100%;
      line-height: 0;
    }
    selection-dialog.large{
      @apply(--layout-fit);
    }
    selection-dialog.large main-button{
      font-size: 5vh;
    }
    selection-dialog.small{
      width: 100vw;
      height: 350px;
    }
    selection-dialog.small main-button{
      font-size: 4vh;
    }
    selection-dialog .text-content{
      @apply(--layout-self-start);
      padding: 24px;
    }
    selection-dialog .text-content p:last-of-type{
      margin: 0;
    }
    selection-dialog .action-btns{
      @apply(--layout-horizontal);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }
    selection-dialog .action-btns main-button{
      font-size: 5.5vw; 
    }
    selection-dialog .align-bottom{
	    position: absolute;
		  bottom: 0;
		  left: 0;
		  right: 0;
	  }
    #pages > section{
      background: -webkit-linear-gradient(160deg, #711740, #bf4337);
      background: -o-linear-gradient(160deg, #711740, #bf4337);
      background: -moz-linear-gradient(160deg, #711740, #bf4337);
      background: linear-gradient(160deg, #711740, #bf4337);
    }
    main-button.large{
      width: calc(100% - 20vw);
      margin: 1vh 10vw;
      font-size: 8vw;
      line-height: 0;
      --max-height: 15vh;
      letter-spacing: 2px;
    }
    main-button.multiline{
      font-size: 4vw !important;
      line-height: normal !important;
      letter-spacing: normal;
    }
    main-button.small-text{
      font-size: 5vw !important;
      letter-spacing: normal;
    }
    #home{
      @apply(--layout-vertical);
    }
    #home > .padder{
      height: 2vh;
    }
    #home #title{
      @apply(--layout-flex);
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
      @apply(--layout-center);
    }
    #home #title img{
      width: 80vw;
    }
    #challenge{
      @apply(--layout-vertical);
    }
    #challenge my-challenges{
      @apply(--layout-flex);
    }
    #create-challenge{
      @apply(--layout-vertical);
    }
    #ingame user-score{
      font-size: 3vh;
    }
    #game-space{
      @apply(--layout-fit);
    }
    #game-space [paper-drawer-toggle]{
      --iron-icon-width: 32px;
      --iron-icon-height: 32px;
    }
    .flex{
      @apply(--layout-flex);
    }
    </style>
    <template>
      <iron-ajax
        id="ajax-friends-list"
        handle-as="json"
        url="[[friendsListDataPath]]"
        params='[[_getAjaxTokenParam(_userToken)]]'
        method="GET"
        on-response="_ajaxFriendsListSuccessHandler"
        on-error="_ajaxFriendsListErrorHandler"></iron-ajax>
	    <iron-ajax
	      id="ajax-challenges-sent-and-received"
	      handle-as="json"
	      url="[[challengesSentAndReceivedDataPath]]"
	      params='[[_getAjaxTokenParam(_userToken)]]'
	      method="GET"
	      on-response="_ajaxChallengesSentAndReceivedSuccessHandler"
	      on-error="_ajaxChallengesSentAndReceivedErrorHandler"></iron-ajax>
      <iron-ajax
        id="ajax-challenge-response"
        handle-as="json"
        url="[[challengeResponsePath]]"
        params='[[_getAjaxChallengeResponseParams(_challengeId, _challengeResponse, _userToken)]]'
        method="GET"
        on-response="_ajaxChallengeResponseSuccessHandler"
        on-error="_ajaxChallengeResponseErrorHandler"></iron-ajax>
      <iron-ajax
	      id="ajax-challenge-someone"
	      handle-as="json"
	      url="[[sendChallengePath]]"
	      params='[[_getAjaxChallengeSomeoneParams(difficulty, time, _challengeId, _gameData.data, _userToken)]]'
	      method="POST"
	      on-response="_ajaxChallengeSomeoneSuccessHandler"
	      on-error="_ajaxChallengeSomeoneErrorHandler"></iron-ajax>
	    <iron-ajax
        id="ajax-complete-challenge"
        handle-as="json"
        url="[[completeChallengePath]]"
        params='[[_getAjaxCompleteChallengeParams(time, _challengeId, _userToken)]]'
        method="POST"
        on-response="_ajaxCompleteChallengeSuccessHandler"
        on-error="_ajaxCompleteChallengeErrorHandler"></iron-ajax>
      <iron-ajax
        id="ajax-get-score"
        handle-as="json"
        url="[[getScoreDataPath]]"
        params='[[_getAjaxTokenParam(_userToken)]]'
        method="GET"
        on-response="_ajaxGetScoreSuccessHandler"
        on-error="_ajaxGetScoreErrorHandler"></iron-ajax>
      <iron-ajax
	      id="ajax-update-score"
	      handle-as="json"
	      url="[[updateScorePath]]"
	      params='[[_getAjaxUpdateScoreParams(score, _userToken)]]'
	      method="POST"
	      on-response="_ajaxUpdateScoreSuccessHandler"
	      on-error="_ajaxUpdateScoreErrorHandler"></iron-ajax>
      <neon-animated-pages id="pages" selected="{{page}}" attr-for-selected="id" transitions="cross-fade-all">
        <section id="home">
          <div id="title">
            <img src="assets/images/title.svg">
          </div>
          <main-button class="large" on-tap="_btnPlayAction">Play</main-button>
          <main-button class="large" hidden$="[[signedin]]" on-tap="_btnSignInAction">Sign In</main-button>
          <main-button class="large" hidden$="[[!signedin]]" on-tap="_btnChallengeAction">Challenge</main-button>
          <main-button class="large" hidden$="[[!signedin]]" on-tap="_btnSignOutAction">Sign Out</main-button>
          <div class="padder"></div>
        </section>
        <section id="challenge">
          <page-heading src="assets/images/heading-challenges.svg"></page-heading>
          <my-challenges>
            <div hidden$="[[!_loadingChallenges]]">Loading...</div>
            <div hidden$="[[_loadingChallenges]]">
              <span hidden$="[[_hasChallenges(newChallengesReceived, challengesSent, completedChallenges)]]">You haven't sent or received any challenges yet.<br></span>
              <span hidden$="[[_noNewChallenges(newChallengesReceived)]]">New Challenges Received:<br></span>
              <template is="dom-repeat" items="[[newChallengesReceived]]">
                <challenge-entry challenge-id="[[item.id]]" name="[[item.from]]" time="[[item.time]]" difficulty="[[item.difficulty]]" on-tap="_newChallengeSelect"></challenge-entry>
              </template>
              <span hidden$="[[_noChallengesSent(challengesSent)]]">Challenges Sent:<br></span>
              <template is="dom-repeat" items="[[challengesSent]]">
                <challenge-entry challenge-id="[[item.id]]" name="[[item.to]]" time="[[item.time]]" difficulty="[[item.difficulty]]"></challenge-entry>
              </template>
              <span hidden$="[[_noChallengesCompleted(completedChallenges)]]">Completed Challenges:<br></span>
              <template is="dom-repeat" items="[[completedChallenges]]">
                <challenge-entry challenge-id="[[item.id]]" name="[[item.player]]" result="[[item.result]]" difficulty="[[item.difficulty]]"></challenge-entry>
              </template>
            </div>
          </my-challenges>
          <main-button on-tap="_btnChallengeSomeoneAction" class="large small-text">Challenge Someone</main-button>
          <challenges-key></challenges-key>
        </section>
        <section id="create-challenge">
          <page-heading src="assets/images/heading-create-challenge.svg"></page-heading>
          <main-select-field selected="[[_challengeFriend]]" options="[[_friends]]" label="Who do you want to challenge?" dialog-label="Friends" on-main-selection="_onMainSelectionSetChallengee"></main-select-field>
          <main-select-field selected="[[_challengeDifficulty]]" options="[[_difficulties]]" dialog-label="Difficulty" label="Difficulty:" on-main-selection="_onMainSelectionSetChallengeDifficulty"></main-select-field>
          <div class="flex"></div>
          <main-button class="large end" on-tap="_btnCreateChallengeSendAction">Create</main-button>
        </section>
        <section id="ingame">
          <paper-drawer-panel force-narrow disable-edge-swipe>
            <paper-header-panel drawer>
              <paper-toolbar><span>Menu</span><span class="flex"></span><user-level level="[[difficulty]]"></user-level></paper-toolbar>
              <paper-menu on-iron-select="_menuSelectAction">
                <paper-icon-item id="menu-item-skip" hidden$="[[_challengeLevel]]">
                  <iron-icon icon="icons:redo" item-icon></iron-icon>
                  <span hidden$="[[_levelComplete]]">Skip this Level</span>
                  <span hidden$="[[!_levelComplete]]">Next Level</span>
                </paper-icon-item>
                <paper-icon-item id="menu-item-change-difficulty" hidden$="[[_challengeLevel]]">
                  <iron-icon icon="icons:extension" item-icon></iron-icon>
                  Change Difficulty
                </paper-icon-item>
                <paper-icon-item id="menu-item-exit" class="new-section">
                  <iron-icon icon="icons:cancel" item-icon></iron-icon>
                  <span hidden$="[[_challengeLevel]]">Exit</span>
                  <span hidden$="[[!_challengeLevel]]">Give Up</span>
                </paper-icon-item>
              </paper-menu>
            </paper-header-panel>
            <paper-header-panel main>
              <game-space id="game-space"
              url-game-data-path="[[gameDataPath]]"
              user-token="[[_userToken]]"
              score="{{score}}"
              time="{{time}}"
              difficulty="{{difficulty}}"
              level-started="{{_levelStarted}}"
              level-complete="{{_levelComplete}}"
              challenge-level="{{_challengeLevel}}"
              game-data="{{_gameData}}"
              letter-tile-src="assets/images/tiles.png"
              tile-size="144"
              on-level-complete="_onLevelComplete"
              on-level-load-fail="_onLevelLoadFail">
                <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
              </game-space>
            </paper-header-panel>
          </paper-drawer-panel>
        </section>
      </neon-animated-pages>
      <selection-dialog id="difficulty-dialog" class="large">
        <h1>Select Difficulty</h1>
        <div style="width: 100%;"></div>
        <main-button data-difficulty="0" on-tap="_btnSetDifficultyAction">Easy</main-button>
        <main-button data-difficulty="1" on-tap="_btnSetDifficultyAction">Medium</main-button>
        <main-button data-difficulty="2" on-tap="_btnSetDifficultyAction">Hard</main-button>
        <div style="width: 100%;"></div>
      </selection-dialog>
      <selection-dialog id="challenge-dialog" class="small">
        <h1>Challenge</h1>
        <div class="text-content">
          <p><span>[[_challengeName]]</span> has callenged you.</p>
          <p>They completed this level on <span>[[_challengeDifficulty]]</span> in a time of <span>[[_formatTime(_challengeTime)]]</span>.</p>
          <p>Think you can do better?</p>
        </div>
        <div class="action-btns">
          <main-button on-tap="_btnChallengeReject">Reject</main-button>
          <main-button on-tap="_btnChallengeAccept">Accept</main-button>
        </div>
      </selection-dialog>
      <selection-dialog id="challenge-complete-dialog" no-close-btn class="small">
        <h1 hidden$="[[!_challengeResultIs(_challengeResult, 'won')]]">You Win</h1>
        <h1 hidden$="[[!_challengeResultIs(_challengeResult, 'lost')]]">You Lost</h1>
        <h1 hidden$="[[!_challengeResultIs(_challengeResult, 'drew')]]">It's a Draw</h1>
        <div class="text-content">
          Your Time: <span>[[levelTime]]</span><br>
          Opponent's Time: <span>[[_formatTime(_challengeTime)]]</span><br>
        </div>
        <div style="width: 100%;">
          <main-button on-tap="_btnChallengeCompleteAction">Exit</main-button>
        </div>
      </selection-dialog>
      <selection-dialog id="challenge-sent-dialog" no-close-btn class="small">
        <h1>Challenge Sent</h1>
        <div class="text-content">
          This challenge has been sent to <span>[[_challengeName]]</span>
        </div>
        <div style="width: 100%;">
          <main-button on-tap="_btnChallengeCompleteAction">Exit</main-button>
        </div>
      </selection-dialog>
      <selection-dialog id="level-win-dialog" class="small">
        <h1>Well Done</h1>
        <div class="text-content">
          Level Score: <span>[[levelScore]]</span><br>
          Time Taken: <span>[[levelTime]]</span><br>
        </div>
        <div style="width: 100%;">
          <main-button on-tap="_btnNextLevelAction">Next Level</main-button>
          <main-button class="multiline" on-tap="_btnLevelCompleteStartChallengeAction">Challenge Someone<br>to this Level</main-button>
        </div>
      </selection-dialog>
      <selection-dialog id="level-loading-error-dialog" class="small" no-close-btn>
        <h1>Error</h1>
        <div class="text-content">
          An error has occured while trying to load the level.
        </div>
        <main-button class="align-bottom" on-tap="_btnLevelLoadErrorOkAction">OK</main-button>
      </selection-dialog>
      <selection-dialog id="exit-dialog" class="small" on-iron-overlay-closed="_onExitDialogClose">
        <h1>Exit</h1>
        <p>Are you sure you want to exit?</p>
        <div class="action-btns">
          <main-button on-tap="_btnExitNo">No</main-button>
          <main-button on-tap="_btnExitYes">Yes</main-button>
        </div>
      </selection-dialog>
    </template>
  </dom-module>
  <script>
  var app;
  
  window.addEventListener('WebComponentsReady', function(e) {
    Polymer({
      is: 'page-element',
      
      properties: {
        /**
         * The name of currently active page.
         */
        page: {
          type: String,
          value: function(){
        	  var page = this._getQueryParams(document.location.search).page;  // the page is provided as a query param
        	  if(!page){
        		  page = 'home';
        	  }
            return page
          },
          observer: '_pageChangeEvent'
        },
        
        /**
         * If the user is logged in, this will be set
         */
        _userToken: {
          type: String,
          value: function(){
            var token = this._getQueryParams(document.location.search).token;  // the token is provided as a query param
            if(!token){
            	token = this.getCookie('token');
            }
            return token;
          },
          observer: '_tokenChangeEvent'
        },
        
        /**
         * The path to the server
         */
        _serverPath:{
        	type: String,
        	value: 'https://still-waters-3351.herokuapp.com/',
        	readOnly: true
        },
        
        /**
         * Signin link to google
         */
        _auth_google_link:{
          type: String,
          value: "https://accounts.google.com/o/oauth2/auth?response_type=code&redirect_uri=https%3A%2F%2Fstill-waters-3351.herokuapp.com%2Fauthredir&scope=email&client_id=431848180596-4n65gocm2d8k71elvq3a6vchtka9cqgv.apps.googleusercontent.com",
          readOnly: true
        },
        
        _gameData:{
        	type: Object,
        	value: {}
        },
        
        /**
         * The path to the json data for the game data.
         */
        gameDataPath: {
          type: String,
          computed: '_join(_serverPath, "play/")'
        },
        
        /**
         * updatescore(score, token)
         */
        updateScorePath: {
          type: String,
          computed: '_join(_serverPath, "updatescore/")'
        },

        getScoreDataPath: {
          type: String,
          computed: '_join(_serverPath, "getscore/")'
        },
        
        // friends(token)
        friendsListDataPath: {
          type: String,
          computed: '_join(_serverPath, "friends/")'
        },
        
        // challengesreceived(token)
        challengesSentAndReceivedDataPath: {
          type: String,
          computed: '_join(_serverPath, "challengesreceivedandsent/")'
        },
        
        // challengessent(token)
        challengesSentDataPath: {
          type: String,
          computed: '_join(_serverPath, "challengessent/")'
        },
        
        // acceptchallenge(challengeid, response, token)
        challengeResponsePath: {
          type: String,
          computed: '_join(_serverPath, "acceptchallenge/")'
        },
        
        sendChallengePath: {
          type: String,
          computed: '_join(_serverPath, "challenge/")'
        },
        
        completeChallengePath: {
          type: String,
          computed: '_join(_serverPath, "completechallenge/")'
        },
        
        /**
         * States whether or not the current level has been complete
         */
        _levelComplete: {
          type: Boolean,
          value: false
        },
        
        /**
         * States whether or not the current level has been complete
         */
        _levelStarted: {
          type: Boolean,
          value: false
        },
          
        /**
         * Whether or not the user is signed in
         */
        signedin: {
        	type: Boolean,
        	value: false,
        	computed: '_isSignedIn(_userToken)'
        },
        
        /**
         * Array of new callenges the user has been sent
         */
        newChallengesReceived: {
        	type: Array,
        	value: []
        },
        
        /**
         * Array of callenges the user has sent out
         */
        challengesSent: {
          type: Array,
          value: []
        },
        
        /**
         * Array of completed callenges both sent and received by the user
         */
        completedChallenges: {
          type: Array,
          value: []
        },
        
        /**
         * When set to true, the app will exit when the back button is pressed
         */
        _exitOnBackButton: {
          type: Boolean,
          value: false
        },
        
        _loadingChallenges: {
          type: Boolean,
          value: false
        },
        
        _challengeResult:{
          type: String,
          value: ''
        },
        
        _challengeTime:{
          type: Number,
          value: 0
        },
        
        _difficulties: {
        	type: Array,
        	value: [
            { id: 0, name: 'Easy'},
            { id: 1, name: 'Medium'},
            { id: 2, name: 'Hard'}
          ]
        },
        
        _friends: {
          type: Array,
          value: []
        }
      },
      
      /**
       * Once this element is initilized
       */
      ready: function(){
        app = this;
      },
      
      attached: function(){
    	  if(this.signedin){
 	        this.$['ajax-get-score'].generateRequest();
    	  }
      },
      
      /**
       * Display the exit prompt
       */
      displayExitPrompt: function(){
        if(!navigator || !navigator.app){
          return;
        }
        if(this._exitOnBackButton){
          this.exit();
        }
        else{
          this._exitOnBackButton = true;
          this.$['exit-dialog'].open();
        }
      },
      
      /**
       * Exit the app
       */
      exit: function(){
        if(navigator && navigator.app){
          navigator.app.exitApp();
        }
      },
      
      /**
       * Join to values together using +
       * returns a + b
       */
      _join: function(a, b){
    	  return a + b;
      },
      
      /**
       * Returns whether or not the user is logged based on the given token
       */
      _isSignedIn: function(token){
        return token !== undefined;
      },
      
      /**
       * Get query paramerters out of the given query string.
       * example:
       *   calling _getQueryParams(a=123&b=456&c=789)
       *   will return { a:123, b:456, c:789 }
       */
      _getQueryParams: function(qs) {
        qs = qs.split('+').join(' ');
        
        var params = {};
        var tokens;
        var re = /[?&]?([^=]+)=([^&]*)/g;
        
        while (tokens = re.exec(qs)) {
          params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
        }
        
        return params;
      },
      
      /**
       * Set the active page.
       * 
       * @param name The name of the page to switch to
       */
      _pageChangeEvent: function(newPage, oldPage){
        var $this = this;
        
        // wait until every else is done.
        setTimeout(function(){
          $this._levelStarted = false;
          
          switch(newPage){
          case 'home':
            break;
            
          case 'ingame':
            if($this._challengeGameData){
              $this.$['game-space'].loadLevel($this._challengeGameData);
            }
            else{
              $this.$['game-space'].newLevel();
            }            
            break;
          
          case 'create-challenge':
            $this.$['ajax-friends-list'].generateRequest();
            break;
          
          case 'challenge':
            $this._loadingChallenges = true;
        	  $this.$['ajax-challenges-sent-and-received'].generateRequest();
        	  break;
          }
          
          history.pushState({page: newPage, token: $this._userToken}, newPage, '?page=' + newPage);
        }, 0);
      },
      
      _tokenChangeEvent: function(token){
    	  if(token){
 	        this.setCookie('token', token);
    	  }
    	  else{
    		  this.deleteCookie('token');
    	  }
      },
      
      setCookie: function(cname, cvalue) {
    	  document.cookie = cname + "=" + cvalue;
    	},
    	
    	getCookie: function(cname) {
    	  var name = cname + "=";
    	  var ca = document.cookie.split(';');
    	  for(var i=0; i<ca.length; i++) {
    	    var c = ca[i];
    	    while (c.charAt(0)==' ') c = c.substring(1);
    	      if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    	    }
    	  return "";
    	},
    	
    	deleteCookie: function( name ) {
  		  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  		},
      
      _challengeResultIs: function(challengeResult, input){
        return challengeResult == input;
      },
      
      /**
       * Called on-tap of the play button.
       */
      _btnPlayAction: function(){
        this.$['difficulty-dialog'].open();
      },

      /**
       * Called on-tap of the challenge button.
       */
      _btnChallengeAction: function(){
        this.page = 'challenge';
      },

      /**
       * Called on-tap of the sign in button.
       */
      _btnSignInAction: function(){
        if(this._auth_google_link){
          window.location.href = this._auth_google_link;
        }
      },
     
      /**
       * Called on-tap of the sign out button.
       */
      _btnSignOutAction: function(){
        this._userToken = undefined;
      },
      
      /**
       * Called on-tap of the difficulty selection buttons.
       */
      _btnSetDifficultyAction: function(e, detail){
        var btn = e.target;
        while(btn && !btn.dataset.difficulty){
        	btn = btn.parentElement;
        }
        // set difficulty before change to the game page
        this.difficulty = parseInt(btn.dataset.difficulty); // make sure the difficulty is a number, not a string
        this.$['difficulty-dialog'].close();                // close the dialog
        
        this._challengeGameData = null;
        if(this.page == 'ingame'){
          this.$['game-space'].newLevel();
        }
        else{
          this.page = 'ingame';
        }
      },
      
      /**
       * Called on-tap of the next level button.
       */
      _btnNextLevelAction: function(){
        this.$['level-win-dialog'].close();
        this.$['game-space'].newLevel();
      },
      
      /**
       * Called on-tap of the ok button in the level loading error dialog.
       */
      _btnLevelLoadErrorOkAction: function(){
        this.$['level-loading-error-dialog'].close();
        this.page = 'home';
      },
      
      /**
       * Called on-tap of a new challenge the user has received
       */
      _newChallengeSelect: function(e){
    	  var challenge = e.target;
    	  while(challenge && challenge.tagName != 'CHALLENGE-ENTRY'){
    		  challenge = challenge.parentNode;
    	  }
    	  if(!challenge){
    		  return;
    	  }
        this._challengeId = challenge.challengeId;
    	  this._challengeName = challenge.name;
        this._challengeTime = formatTime(challenge.time);
        this._challengeDifficulty = this._difficultyIntToString(challenge.difficulty);
    	  this.$['challenge-dialog'].open();
      },
      
      /**
       * Called on-tap of the accept challenge button
       */
      _btnChallengeAccept: function(){
        this._challengeResponse = true;
        this.$['ajax-challenge-response'].generateRequest();
        this.$['challenge-dialog'].close();
      },
      
      /**
       * Called on-tap of the reject challenge button
       */
      _btnChallengeReject: function(){
        this._challengeResponse = false;
        this.$['ajax-challenge-response'].generateRequest();
        this.$['challenge-dialog'].close();
      },
      
      /**
       * Called on-tap of the challenge someone button
       */
      _btnChallengeSomeoneAction: function(){
    	  this.page = 'create-challenge';
      },
      
      _btnLevelCompleteStartChallengeAction: function(){
    	  
      },
      
      _btnChallengeCompleteAction: function(){
        this.$['challenge-complete-dialog'].close();
        this.$['challenge-sent-dialog'].close();
        this.page = 'home';
      },
      
      _btnCreateChallengeSendAction: function(){
        this._createChallengeOnLevelCompete = true;
        this.page = 'ingame';
      },
      
      /**
       * Called on-tap of the yes button in the exit prompt
       */
      _btnExitYes: function(){
        this.exit();
      },
      
      /**
       * Called on-tap of the no button in the exit prompt
       */
      _btnNoYes: function(){
        this.$['exit-dialog'].close();
      },
      
      _onMainSelectionSetChallengee: function(e, detail){
    	  this._challengeId = detail.id;
    	  this._challengeName = detail.name;
      },
      
      _onMainSelectionSetChallengeDifficulty: function(e, detail){
    	  this.difficulty = detail.id;
      },
      
      /**
       * Called on-tap of the no button in the exit prompt
       */
      _onExitDialogClose: function(){
        this._exitOnBackButton = false;
      },
      
      /**
       * Called when an error occurs during a level load.
       */
      _onLevelLoadFail: function(){
        this.$['level-loading-error-dialog'].open();
      },
      
      /**
       * Called when a level is complete
       */
      _onLevelComplete: function(){
        var time = this.$['game-space'].time;
        
    	  this.levelScore = this.$['game-space'].getScore();
    	  this.levelTime = formatTime(time);
    	  this.score += this.levelScore;
    	  if(this.signedin && !this._challengeLevel){
 	        this.$['ajax-update-score'].generateRequest();
    	  }
    	  
    	  if(this._createChallengeOnLevelCompete){
    		  this._createChallengeOnLevelCompete = false;
    		  this.$['ajax-challenge-someone'].generateRequest();
    	  }
    	  else if(this._challengeGameData){
    		  this.$['ajax-complete-challenge'].generateRequest();
    	    if(time < this._challengeTime){
    	      this._challengeResult = 'won';
    	    }
    	    else if(time > this._challengeTime){
            this._challengeResult = 'lost';
          }
    	    else{
    	      this._challengeResult = 'drew';
    	    }

    	    this.$['challenge-complete-dialog'].open();
    	  }
    	  else{
    	    this.$['level-win-dialog'].open();
    	  }
      },

      /**
       * Called when a menu item is selected.
       */
      _menuSelectAction: function(e, detail){
        var id = detail.item.id;
        switch(id){
        case 'menu-item-skip':
          this.$['game-space'].newLevel();
          break;
        
        case 'menu-item-change-difficulty':
        	this.$['difficulty-dialog'].open();
        	break;
        
        case 'menu-item-exit':
          this.page = 'home';
          break;
        
        default:
          break;
        }
        
        Polymer.dom(e.target).querySelector('.iron-selected').blur(); // unfocuse the item
        e.target.selected = -1; // deselect the item
        Polymer.dom(this.$.ingame).querySelector('paper-drawer-panel').closeDrawer(); // close the drawer
      },
      
      /**
       * Returns whether or not the user has sent and received no challenges
       */
      _hasChallenges: function(a, b, c){
    	  return a.length > 0 || b.length > 0 || c.length > 0;
      },
      
      /**
       * Returns whether or not the user has received new challenges
       */
      _noNewChallenges: function(a){
    	  return a.length == 0;
      },
      
      /**
       * Returns whether or not the user has sent challenges
       */
      _noChallengesSent: function(b){
    	  return b.length == 0;
      },
      
      /**
       * Returns whether or not the user has completed any challenges
       */
      _noChallengesCompleted: function(c){
    	  return c.length == 0;
      },
      
      /**
       * Returns the difficulty (easy, medium, hard) that the given integer represents  
       */
      _difficultyIntToString: function(difficulty){
   	    switch (difficulty){
   	    case 0: return 'easy';
   	    case 1: return 'medium';
   	    case 2: return 'hard';
   	    }
   	  },
   	  
   	  _formatTime: function(time){
   	    return formatTime(time);
   	  },
      
      /**
       * Get the token as a paramater for a request to send to the server
       */
      _getAjaxTokenParam: function(_token){
    	  return { token: _token };
      },
      
      /**
       * Get the params from the challenge response request to send to the server
       */
      _getAjaxChallengeResponseParams: function(_id, _response, _token){
    	  return {
    		  challenge_id: _id,
    		  response: _response,
    		  token: _token
    	  };
      },
      
      /**
       * Get the params from the update score request to send to the server
       */
      _getAjaxUpdateScoreParams: function(_score, _token){
        return {
          score: _score,
          token: _token
        };
      },
      
      /**
       * Handeler for when the challenges received ajax request succeed
       */
      _ajaxChallengesSentAndReceivedSuccessHandler: function(event, detail, sender){
    	  var ncr = [];
    	  var cs = [];
    	  var cc = [];
    	  
    	  if(detail.response){
      	  for(var i=0; i<detail.response.length; i++){
      		  switch (detail.response[i].result){
      		  case 'incomplete':
      		    if(detail.response[i].sent){
      		      cs.push({
      		        id: detail.response[i].challenge_id,
                  to: detail.response[i].challengee,
                  time: detail.response[i].challenger_time_taken,
                  difficulty: detail.response[i].difficulty
                }); 
      		    }
      		    else{
      		      ncr.push({
      		        id: detail.response[i].challenge_id,
                  from: detail.response[i].challenger,
                  time: detail.response[i].challenger_time_taken,
                  difficulty: detail.response[i].difficulty
                });
      		    }
      		    break;
      	          
            default:
              cc.push({
                id: detail.response[i].challenge_id,
                player: detail.response[i].sent ? detail.response[i].challengee : detail.response[i].challenger,
                result: detail.response[i].result,
                difficulty: detail.response[i].difficulty
              });
              break;
      		  }
      	  }
    	  }

        this.newChallengesReceived = ncr;
        this.challengesSent = cs;
        this.completedChallenges = cc;
        this._loadingChallenges = false;
      },
      
      /**
       * Handeler for when the challenges received ajax request fails
       */
      _ajaxChallengesSentAndReceivedErrorHandler: function(event, detail, sender){
        console.error('failed to get challenges sent and received.');
      },
      
      /**
       * Handeler for when the challenges sent ajax request succeed
       */
      _ajaxChallengesSentSuccessHandler: function(event, detail, sender){
        
      },
      
      /**
       * Handeler for when the challenges sent ajax request fails
       */
      _ajaxChallengesSentErrorHandler: function(event, detail, sender){
        console.error('failed to get challenges sent.');
      },
      
      /**
       * Handeler for when the challenges response ajax request succeed
       */
      _ajaxChallengeResponseSuccessHandler: function(event, detail, sender){
        this._acceptChallenge(detail.response);
      },
      
      _acceptChallenge: function(gamedata){
        this._challengeGameData = gamedata;
        this.page = 'ingame';
      },
      
      /**
       * Handeler for when the challenges response ajax request fails
       */
      _ajaxChallengeResponseErrorHandler: function(event, detail, sender){
        console.error('failed to send challenge response.');
      },
      
      /**
       * Handeler for when the friends list ajax request succeed
       */
      _ajaxFriendsListSuccessHandler: function(event, detail, sender){
    	  var r = detail.response;
    	  var newF = [];
    	  for(var i=0;i<r.length;i++){
    		  newF.push({
    			  name: r[i].display_name,
    			  score: r[i].score,
            id: r[i].user_id
    		  });
    	  }
        this._friends = newF;
      },
      
      /**
       * Handeler for when the friends list ajax request fails
       */
      _ajaxFriendsListErrorHandler: function(event, detail, sender){
        console.error('failed to get friends list.');
      },
      
      /**
       * Handeler for when the update score ajax request succeed
       */
      _ajaxUpdateScoreSuccessHandler: function(event, detail, sender){
        
      },
      
      /**
       * Handeler for when the update score ajax request fails
       */
      _ajaxUpdateScoreErrorHandler: function (event, detail, sender) {
        console.error('coundn\'t update user score.');
      },
      
      /**
       * Handeler for when the get score ajax request succeed
       */
      _ajaxGetScoreSuccessHandler: function(event, detail, sender){
        this.score = parseInt(detail.response.score);
      },
      
      /**
       * Handeler for when the get score ajax request fails
       */
      _ajaxGetScoreErrorHandler: function (event, detail, sender) {
        console.error('coundn\'t get user score.');
      },
      
      /**
       * Handeler for when the challenge someone ajax request succeed
       */
      _ajaxChallengeSomeoneSuccessHandler: function(event, detail, sender){
    	  this.$['challenge-sent-dialog'].open();
      },
      
      /**
       * Handeler for when the challenge someone ajax request fails
       */
      _ajaxChallengeSomeoneErrorHandler: function (event, detail, sender) {
        console.error('coundn\'t send challenge.');
      },
      
      /**
       * Get the params from the challenge someone request to send to the server
       */
      _getAjaxChallengeSomeoneParams: function(_difficulty, _time, _id, _gameData, _token){
        return {
          difficulty: _difficulty,
          time: _time,
          user_id: _id,
          token: _token,
          game: JSON.stringify(_gameData)
        };
      },
      
      /**
       * Handeler for when the complete challenge ajax request succeed
       */
      _ajaxCompleteChallengeSuccessHandler: function(event, detail, sender){
        //this.$['challenge-sent-dialog'].open();
      },
      
      /**
       * Handeler for when the complete challenge ajax request fails
       */
      _ajaxCompleteChallengeErrorHandler: function (event, detail, sender) {
        console.error('coundn\'t send challenge.');
      },
      
      /**
       * Get the params from the complete challenge request to send to the server
       */
      _getAjaxCompleteChallengeParams: function(_time, _id, _token){
        return {
        	time_taken: _time,
          challenge_id: _id,
          token: _token
        };
      }
    });
  });
  
  window.onpopstate = function(event) {
    app._userToken = event.state.token;
    app.page = event.state.page;
  };
	  
  document.addEventListener('deviceready', function(){
    /**
     * Handler for the back button
     */
    document.addEventListener('backbutton', function(){
      switch(app.page){
      case 'home':
        app.displayExitPrompt();
        break;
      case 'ingame':
        app.page = 'home'
        break;
      case 'challenge':
        app.page = 'home';
        break;
      case 'create-challenge':
        app.page = 'challenge';
        break;
      }
    }, false);
  }, false);
  </script>
  
  <page-element></page-element>
</body>
</html>